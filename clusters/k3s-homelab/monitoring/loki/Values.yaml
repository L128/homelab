# Loki 自定义配置（补丁格式）

# 持久化存储配置（默认值：false）
loki:
  # 核心配置 - 添加缺失的 schema_config
  config:
    # 存储架构配置（解决 Helm 安装失败的关键）
    schemaConfig:
      configs:
        - from: "2024-04-01"  # 使用近期日期作为起始点
          object_store: s3  # 与下方 storage.type 保持一致
          store: tsdb  # 当前唯一推荐的值
          schema: v13  # 最新的 schema 版本
          index:
            prefix: index_  # 索引前缀
            period: 24h  # 索引周期，必须为 24h
  
  persistence:
    enabled: true
    storageClassName: "longhorn"
    size: 50Gi
    persistentVolumeClaimRetentionPolicy:
      whenDeleted: Retain
      whenScaled: Retain
  
  # 存储配置 - SimpleScalable 模式需要对象存储
  storage:
    # 定义对象存储类型
    type: s3
    # 配置存储后端（示例为 MinIO）
    s3:
      endpoint: "minio.default.svc.cluster.local:9000"  # 存储端点
      region: "us-east-1"
      accessKeyId: "${MINIO_ACCESS_KEY}"  # 使用 secret 存储凭证
      secretAccessKey: "${MINIO_SECRET_KEY}"
      insecure: true  # 对于没有 TLS 的 MinIO
    # 必需的存储桶名称（解决错误的关键）
    bucketNames:
      chunks: "loki-chunks"  # 用于块存储的桶
      ruler: "loki-ruler"    # 用于 ruler 的桶
      admin: "loki-admin"    # 用于管理操作的桶

# 资源请求和限制配置
resources:
  requests:
    cpu: "100m"
    memory: "256Mi"
  limits:
    cpu: "1"
    memory: "1Gi"

# 亲和性配置（默认值：空）
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
    - weight: 100
      podAffinityTerm:
        labelSelector:
          matchExpressions:
          - key: app.kubernetes.io/name
            operator: In
            values:
            - loki
        topologyKey: kubernetes.io/hostname